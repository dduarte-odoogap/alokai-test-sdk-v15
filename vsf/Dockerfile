ARG IMAGE_NODE_VERSION="20.10.0" \
    YARN_VERSION="3.6.1" \
    NUXT_PUBLIC_ODOO_BASE_URL="https://vsf-odoo18.labs.erpgap.com/" \
    NUXT_PUBLIC_ODOO_BASE_IMAGE_URL="https://vsf-odoo18.labs.erpgap.com/" \
    NUXT_PUBLIC_MIDDLEWARE_URL="http://localhost:3000/" \
    NUXT_PUBLIC_MIDDLEWARE_PORT=8443 \
    NUXT_STORAGE_URL="redis://redis:6379" \
    NUXT_STORAGE_DRIVER="redis" \
    NUXT_ALGOLIA_API_KEY="change_api_key" \
    NUXT_ALGOLIA_APPLICATION_ID="change_application_id" \
    PORT=3000

FROM node:${IMAGE_NODE_VERSION}-slim AS base

ARG IMAGE_NODE_VERSION \
    NUXT_ALGOLIA_API_KEY \
    NUXT_ALGOLIA_APPLICATION_ID \
    NUXT_PUBLIC_ODOO_BASE_URL \
    NUXT_PUBLIC_ODOO_BASE_IMAGE_URL \
    NUXT_PUBLIC_MIDDLEWARE_URL \
    NUXT_PUBLIC_MIDDLEWARE_PORT \
    NUXT_STORAGE_URL


ENV NODE_ENV=production \
    NODE_VERSION=${IMAGE_NODE_VERSION} \
    NUXT_PUBLIC_ODOO_BASE_URL=${NUXT_PUBLIC_ODOO_BASE_URL} \
    NUXT_PUBLIC_ODOO_BASE_IMAGE_URL=${NUXT_PUBLIC_ODOO_BASE_IMAGE_URL} \
    NUXT_PUBLIC_MIDDLEWARE_URL=${NUXT_PUBLIC_MIDDLEWARE_URL} \
    NUXT_PUBLIC_MIDDLEWARE_PORT=${NUXT_PUBLIC_MIDDLEWARE_PORT} \
    NUXT_STORAGE_URL=${NUXT_STORAGE_URL} \
    NUXT_ALGOLIA_API_KEY=${NUXT_ALGOLIA_API_KEY} \
    NUXT_ALGOLIA_APPLICATION_ID=${NUXT_ALGOLIA_APPLICATION_ID} \
    NUXT_TELEMETRY_DISABLED=1

RUN yarn set version ${YARN_VERSION}
WORKDIR /src

# Build
FROM base AS build

COPY src/storefront-ui/ ./

RUN apt-get update \
    && rm -rf /var/lib/apt/lists/* \
    && yarn install \
    --prefer-offline \
    --frozen-lockfile \
    --non-interactive \
    --production=false \
    && yarn build

# Run
FROM base
ARG IMAGE_NODE_VERSION \
    NUXT_PUBLIC_ODOO_BASE_URL \
    NUXT_PUBLIC_ODOO_BASE_IMAGE_URL \
    NUXT_STORAGE_URL \
    PORT

ENV PORT=$PORT \
    NODE_ENV=production \
    NUXT_ALGOLIA_API_KEY=${NUXT_ALGOLIA_API_KEY} \
    NUXT_ALGOLIA_APPLICATION_ID=${NUXT_ALGOLIA_APPLICATION_ID} \
    NUXT_TELEMETRY_DISABLED=1 \
    NUXT_STORAGE_URL=${NUXT_STORAGE_URL} \
    NODE_VERSION=${IMAGE_NODE_VERSION}

COPY --from=build /src/apps/web/.output ./

# Expose both ports
EXPOSE $PORT

# Specify the command to run your app
CMD [ "node", "/src/server/index.mjs" ]
